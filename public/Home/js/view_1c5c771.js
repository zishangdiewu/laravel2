$(function(){function e(e){return e.replace(/&{1}/g,"&amp;").replace(/<{1}/g,"&lt;").replace(/>{1}/g,"&gt;")}function t(e){return null==e?"":e.replace(/\s+/g,"").replace(/[\r\n]/g,"")}var n,a,s={init:function(){var e=this;$(".invoice-info").children(":first").addClass("on"),e.initData(),e.computeAndSetSum(),e.setTaxTitleDefault(),e.setAddressAndPerson(),e.initEvent(),$(".sel-select-coupon").trigger("change")},initData:function(){var e=this,t=0;$(".J_total-price").each(function(){t+=parseFloat($(this).text())});var n=0;$(".J_promotion-price").each(function(){n+=Math.abs(parseFloat($(this).text()))}),t+=n,e.baseData={sum:t,privilege:n}},computeAndSetSum:function(){var e=this,t=e.baseData.sum,a=e.baseData.privilege,s=$(".sel-select-coupon option:selected"),i=parseFloat(s.attr("data-amount")),r=s.attr("data-type");"4001"==r?n=0:r?(a+=i,isBaseOnAmount?a>=t?(a=t,n=basePostFee):n=t-a>=baseAmount?0:basePostFee:n=postFee):n=isBaseOnAmount?t-a>=baseAmount?0:basePostFee:postFee;var o=t-a+n;return 0>o&&(o=0),$("#privilege").text(a.toFixed(2)),$("#postAmount").text(n.toFixed(2)),$(".price").html("<dfn>&yen;</dfn>"+t.toFixed("2")),$(".real-price").html("<dfn>&yen;</dfn>"+o.toFixed("2")),o},initEvent:function(){var e=this;e.modifiedPayMethodEvent(),e.modifiedInvoiceEvent(),e.addressSetDefaultEvent(),e.addressDelEvent(),e.addressEditEvent(),e.checkCouponEvent(),e.changeCouponEvent(),e.submitOrderEvent(),e.selectAddressEvent(),e.setTaxTitleDefault(),e.setTaxType(),e.taxTitleNumberLimit(),e.orderMemoNumberLimit(),e.saveAddressEvent(),e.cancelSaveAddressEvent(),e.modelEvent(),e.back2shopCart()},modifiedPayMethodEvent:function(){$(".paymethod-info").children(".pay-method").on("click",function(){$(this).siblings().removeClass("on"),$(this).addClass("on"),$("#j_payTypeText").text("已选择："+$(this).text())}),$(".paymethod-info").find(".on").trigger("click")},modifiedInvoiceEvent:function(){$(".invoice-info").children(".tax-type").on("click",function(){$(".invoice-info").children(".tax-type").removeClass("on"),$(this).addClass("on")})},getRegionEvent:function(){return a=a||new Region({container:$("#j_ReginContriner")})},addressSetDefaultEvent:function(){var e=this;$(".address-info").on("click.setDefault",".operations-address-set-default",function(){var t=this;$.ajax({url:webCtx+"/userAddress/setDefault",type:"POST",data:{id:$(this).val()},success:function(n){200==n.retCode?($(t).parents("li").find("input").trigger("click"),e.setTaxTitleDefault(),$(".address-info").find(".operations").each(function(){if(0==$(this).find(".operations-address-set-default").length){var e=$(this).find(".operations-address-edit"),t=e.attr("value");e.before('<li value = "'+t+'" class= "operations-address-set-default"> 设为默认地址 </li>')}}),$(t).remove()):new Dialog({confirmBtn:!0,content:n.retMsg,icon:"warning"}).show()}})})},addressDelEvent:function(){$(".address-info").on("click.del",".operations-address-del",function(){var e=this;new Dialog({confirmBtn:!0,cancelBtn:!0,content:"确定删除此地址吗?",icon:"warning",confirmCallback:function(){$.ajax({url:webCtx+"/userAddress/del",type:"POST",data:{id:$(e).val()},success:function(t){200==t.retCode&&($(e).parents(".address-item").remove(),$(".address-info>ul").find("li.J_address-item").size()<11&&($("#use-new-address").show(),$("#use-new-address").removeAttr("style")))}})}}).show()})},checkCouponEvent:function(){$("#check_coupon").on("click",function(){if(!$.trim($(".txt-coupon-num").val()))return void new Dialog({confirmBtn:!0,content:"温馨提示:请输入优惠券号码!",icon:"warning"}).show();var e=$.trim($(".txt-coupon-num").val());$.ajax({url:webCtx+"/coupon/bind",type:"POST",data:{couponNum:e,requestUuid:$("#requestUuid").val()},success:function(t){if(200==t.retCode)if(1==t.usable){var n='<option value="'+t.couponNum+'" data-amount="'+t.couponAmount+'" data-type="'+t.couponType+'">'+t.couponName+"</option>",a=$(n);$(".sel-select-coupon:first").prepend(a);var s,i=-1;$(".sel-select-coupon option").each(function(){var e=parseInt($(this).attr("data-amount"));e>i&&(i=e,s=$(this).attr("value"))}),$(".sel-select-coupon:first").val(s),new Dialog({confirmBtn:!0,content:"温馨提示:绑定成功"+e,icon:"success"}).show(),$(".txt-coupon-num").val(""),$(".sel-select-coupon").trigger("change")}else new Dialog({confirmBtn:!0,icon:"warning",content:"温馨提示:绑定成功"+e+",此券不可用于此订单!"}).show();else 600==t.retCode?LoginConfirm.redirect():new Dialog({icon:"warning",confirmBtn:!0,content:"温馨提示:"+t.retMsg}).show()},error:function(){new Dialog({icon:"warning",confirmBtn:!0,content:"温馨提示:系统异常,请稍后!"}).show()}})})},changeCouponEvent:function(){var e=this;$(".sel-select-coupon").on("change",function(){e.computeAndSetSum()})},orderDataValidate:function(){var e=this,t=$(".J_address-item.on").attr("value");if(!t)return new Dialog({confirmBtn:!0,content:"温馨提示:请先选择收货地址!"}).show(),!1;var n=$.trim($("#tax-title").val());if(!n)return new Dialog({confirmBtn:!0,content:"温馨提示:发票抬头必填!"}).show(),$("#tax-title").focus(),!1;var a=document.getElementById("tax-title").value.length;if(a>50)return new Dialog({confirmBtn:!0,content:"温馨提示:发票抬头请输入少于50个字符!"}).show(),$("#tax-title").focus(),!1;var s=e.computeAndSetSum();return s>20000.00001?(new Dialog({confirmBtn:!0,content:"温馨提示:订单金额大于2万,请联系工作人员进行购买!"}).show(),!1):0>=s?(new Dialog({confirmBtn:!0,content:"温馨提示:订单金额必须大于0，请修改订单!"}).show(),!1):!0},submitOrderEvent:function(){var e=this;$("#btn-submit-order").bind("click",function(){if(e.orderDataValidate()){var t=new Dialog({icon:"warning",content:"提交订单需要几秒钟,请耐心等待..."});t.show();var n,a,s,i=$("#buyMode").val(),r=$("#requestUuid").val(),o=[];2==i&&(n=$(".order-commodity-main").attr("skuId"),a=$(".order-commodity-main").attr("spuId"),$(".order-commodity-service").each(function(){o.push($(this).val())}),s=$(".order-commodity-main").attr("num"));var d=$(".J_address-item.on").val(),c=$(".tax-type.on").attr("value"),l=$.trim($("#tax-title").val()),u=$("#order-memo").val(),p=$(".pay-method.on").attr("value"),m=$(".sel-select-coupon option:selected").val(),f={skuId:n,sSkuIds:o,num:s,addressId:d,taxType:c,taxCompany:l,orderMemo:u,payMethod:p,couponNum:m,requestUuid:r},v=this;$(v).attr("disabled","disabled"),$.ajax({url:"submit",data:$.param(f,!0),type:"POST",dataType:"JSON",success:function(e){if(e&&503==e.retCode)return t.hide(),$(v).attr("disabled",!1),new Dialog({confirmBtn:!0,content:"温馨提示:当前服务器太忙，请稍后重试!"}).show(),!1;if(200==e.retCode){var n=e.paraMap;if(null!=n){var s=e.redirect;$("#orderPayform").attr("action",s),$.each(n,function(e,t){$("#orderPayform").append("<input type='hidden' name='"+e+"' value='"+t+"' />")}),$("#orderPayform").submit()}else window.location=webCtx+e.redirect}else 223==e.retCode||224==e.retCode||226==e.retCode?(new Dialog({content:e.retMsg,icon:"warning"}).show(),window.setTimeout(function(){window.location=webCtx+"/product/"+a},3e3)):225==e.retCode?(new Dialog({content:e.retMsg,icon:"warning"}).show(),window.setTimeout(function(){window.location=webCtx+"/my/order/"},3e3)):1==i?(t.hide(),new Dialog({content:e.retMsg,icon:"warning"}).show(),window.setTimeout(function(){window.location=webCtx+"/shoppingcart"},3e3)):(t.hide(),new Dialog({content:e.retMsg,icon:"warning"}).show(),window.setTimeout(function(){window.location=webCtx+"/product/"+a},3e3))},error:function(e){window.location.href=0==e.status?window.location:webCtx+"/error/forbidden"}})}})},selectAddressEvent:function(){var e=this;$(".address-info>ul").on("click","li.J_address-item",function(){if($(this).addClass("on"),$(this).siblings().each(function(){$(this).removeClass("on")}),"use-new-address"!=$(this).attr("id")){$("#opertions-cancel").remove(),$(".address-info-new").hide();var t=$(".tax-type.on").attr("value");1==t&&e.setTaxTitleDefault()}else{e.getRegionEvent(),e.clearNewOrEditAddress(),$(".address-info-new").show(),$("#opertions-cancel").remove();var n='<ul class="operations" id="opertions-cancel"><li class="operations-address-cancel">取消</li></ul>';$("#use-new-address").append(n)}e.setAddressAndPerson()})},cancelSaveAddressEvent:function(){$("#use-new-address").on("click",".operations-address-cancel",function(){$("#opertions-cancel").remove(),$(".address-info-new").hide()}),$("#cancelSaveAddress").on("click",function(){$("#opertions-cancel").remove(),$(".address-info-new").hide()})},addressCheck:function(){return i.form()?!0:void i.focusInvalid()},saveAddressEvent:function(){var t=this;$("#saveAddress").click(function(){if(!t.addressCheck())return!1;var n=$(".J_address-item.on").val(),a=!0;n&&(a=!1);var s=$("input[name=defaultAddress]").is(":checked"),i=t.getAddressParams(),r=i.address;a||i.data.push({name:"id",value:n}),i.data.push({name:"defaultAddr",value:s}),$.ajax({url:webCtx+"/userAddress/newOrEdit",type:"POST",data:i.data,success:function(n){if(200==n.retCode){var i=n.id;if(a){var o=[];o.push('<li class="address-item J_address-item on" name="address" value="'+i+'"><label class="inner">'),o.push('<p class="item-top"><span name="address.receiverName">'+e(r.receiverName)+"</span> "),o.push('<span name="address.mobilePhone">'+e(r.mobilePhone)+"</span> "),o.push('<span name="address.telPhone" hidden>'+r.telPhone+"</span></p>"),o.push('<p><span name="address.province">'+e(r.province)+"</span> "),o.push('<span name="address.city">'+e(r.city)+"</span> "),o.push('<span name="address.area">'+e(r.area)+"</span> "),o.push('<span name="address.address">'+e(r.address)+"</span>"),o.push('<span name="address.zipCode">'+(r.postcode||"")+"</span></p></label>"),o.push('<ul class="operations">'),o.push('<li value="'+i+'" class="operations-address-set-default">设为默认地址</li>'),o.push('<li value="'+i+'" class="operations-address-edit">编辑</li>'),o.push('<li value="'+i+'" class="operations-address-del">删除</li>'),o.push("</ul></li>"),$(o.join("")).insertBefore($("#use-new-address")),$("#use-new-address").removeClass("on"),$(".address-info>ul").find("li.J_address-item").size()>=11&&$("#use-new-address").hide()}else{var d=$(".J_address-item.on >label");d.find("span[name='address.receiverName']").text(e(r.receiverName)),d.find("span[name='address.province']").text(e(r.province)),d.find("span[name='address.city']").text(e(r.city)),d.find("span[name='address.area']").text(e(r.area)),d.find("span[name='address.address']").text(e(r.address)),d.find("span[name='address.mobilePhone']").text(e(r.mobilePhone)),d.find("span[name='address.telPhone']").text(e(r.telPhone))}s&&$("li[value="+i+"].operations-address-set-default").trigger("click"),t.clearNewOrEditAddress(),$(".address-info-new").hide(),t.setTaxTitleDefault(),$("#opertions-cancel").remove()}else $("#use-new-address").hide(),new Dialog({confirmBtn:!0,content:n.retMsg,icon:"warning"}).show();t.setAddressAndPerson()},error:function(){$(".J_address.on").val()}})})},clearNewOrEditAddress:function(){var e="input[type=hidden],input[type=text],textarea,select";$(".address-info-new").find(e).each(function(){$(this).val("")});var t="select[name=city],select[name=area]";$(".address-info-new").find(t).each(function(){$(this).empty(),$(this).hide()})},setTaxTitleDefault:function(){var e=this,t=$(".J_address-item.on"),n=e.getAddressDetail(t),a=$(".tax-type.on").attr("value");2==a?($("#tax-title").val(""),$("#tax-title").attr({placeholder:"最多50个字符"})):1==a&&$("#tax-title").val(n.receiverName)},getAddressDetail:function(e){var t=e.find("span[name='address.receiverName']").text(),n=e.find("span[name='address.province']").text(),a=e.find("span[name='address.city']").text(),s=e.find("span[name='address.area']").text(),i=e.find("span[name='address.address']").text(),r=e.find("span[name='address.mobilePhone']").text(),o=e.find("span[name='address.telPhone']").text(),d=e.find("span[name='address.zipCode']").text(),c={receiverName:t,province:n,city:a,area:s,address:i,mobilePhone:r,telPhone:o,zipCode:d};return c},addressEditEvent:function(){var e=this;$(".address-info").on("click.edit",".operations-address-edit",function(){var t=($(this).val(),$(this).parents("li"));t.addClass("on"),e.clearNewOrEditAddress();var n=e.getAddressDetail(t),s=$(".address-info-new");s.find("input[name='receiverName']").val(n.receiverName),s.find("input[name='address']").val(n.address),s.find("input[name='mobilePhone']").val(n.mobilePhone),s.find("input[name='telPhone']").val(n.telPhone),s.find("input[name='postcode']").val(n.zipCode),0==t.find(".operations-address-set-default").length?s.find("input[name='defaultAddress']").prop("checked",!0):s.find("input[name='defaultAddress']").prop("checked",!1),$(".address-info-new").show(),a=e.getRegionEvent(),a.setValue([n.province,n.city,n.area])})},getAddressParams:function(){var e={},n=[],a={},s="input[type=hidden],input[type=text],textarea,select";return $(".address-info-new").find(s).each(function(){n.push({name:this.name,value:t($(this).val())}),a[this.name]=t($(this).val())}),e.data=n,e.address=a,e},setTaxType:function(){var e=this;$(".tax-type").on("click",function(){e.setTaxTitleDefault()})},taxTitleNumberLimit:function(){$("#tax-title").on("input propertychange",function(){var e=$(this).val().length;e>=50&&$(this).val($(this).val().substr(0,49))})},orderMemoNumberLimit:function(){$("#order-memo").on("input propertychange",function(){$("#order-memo").on("input propertychange",function(){var e=$(this).val().length;e>=300&&$(this).val($(this).val().substr(0,299))})})},setAddressAndPerson:function(){var e=this,t=$(".J_address-item.on");if("use-new-address"!=$(this).attr("id")){var n=e.getAddressDetail(t);$("#receiveAddress").text(n.province+n.city+n.area+n.address),$("#receivePerson").text(n.receiverName+" "+n.mobilePhone)}else $("#receiveAddress").text(""),$("#receivePerson").text("")},modelEvent:function(){$(".icon-close,.confirm-cancel").on("click",function(){$("#j_OrderSubmitDataCheckDialog").fadeOut(),VIVO_UI.unmask()})},back2shopCart:function(){$("#btn-back2shoppingcart").on("click",function(){window.location.href=webCtx+"/shoppingcart"})}};$.validator.addMethod("address",function(e,t){return this.optional(t)||"_NULL_"!=e}),$.validator.addMethod("isMobile",function(e,t){var n=e.length,a=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(t)||11==n&&a.test(e)},"请正确填写手机号码！"),jQuery.validator.addMethod("isphone",function(e,t){var n=(e.length,/(^(\d{3,4}-)?\d{6,8}$)|(^(\d{3,4}-)?\d{6,8}(-\d{1,5})?$)|(\d{11})/);return this.optional(t)||n.test(e)},"请填写正确的电话号码!"),$.validator.addMethod("address_detail",function(e,t){e=$.trim(e),$("input[type='text'][name='address']").val(e);var n=e.length;return this.optional(t)||50>=n&&n>0}),$.validator.addMethod("receive_name",function(e,t){e=$.trim(e),$("input[type='text'][name='receiverName']").val(e);var n=e.length;return this.optional(t)||20>=n&&n>0});var i=$("#shipping-address-new-edit").validate({debug:!0,errorElement:"span",errorClass:"error-style",focusInvalid:!1,rules:{province:{address:!0},city:{address:!0},area:{address:!0},address:{required:!0,address_detail:!0},receiverName:{required:!0,receive_name:!0},mobilePhone:{required:!0,isMobile:!0},telPhone:{isphone:!0},zipCode:{required:!0,number:!0},taxTitle:{maxlength:50}},messages:{province:{address:"请选择省份！"},city:{address:"请选择市区！"},area:{address:"请选择区域！"},address:{required:"请填写详细地址！",address_detail:"详细地址小于50个字符！"},receiverName:{required:"请填写收件人姓名！",receive_name:"姓名小于20个字符！"},mobilePhone:{required:"请输入手机号码！",isMobile:"请正确填写手机号码！"},telPhone:{isphone:"请填写正确的电话号码!"},zipCode:{required:"请填写邮编！",number:"必须为数字!"},taxTitle:{maxlength:"请输入少于50个字符!"}}});s.init()});