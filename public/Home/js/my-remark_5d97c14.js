$(function(){VIVO_UI.HighLightMyCenterNav("我的评论");var t='<li class="image-item image upload-image"><div class="mask"></div><i class="delete"></i></li>',e=!0,i=function(e,i,n){n.before($(t).prepend($("<img/>").attr({src:imghostUrl+i,absOriUrl:e,absThumbUrl:i})))},n=function(t){var e=t.siblings(".image").size();e>=3?t.hide().removeClass("add").find("span").text("正在上传"):t.show().addClass("add").find("span").text("添加图片")},a=function(t){t.find(".uploadFile").fileupload({url:webCtx+"/my/remark/upload-image?t="+(new Date).getTime(),dataType:"json",autoUpload:!0,sequentialUploads:!0,done:function(t,a){var s=$(this).parent();if(200==a.result.retCode){var l=a.result.retMsg.bigPic,o=a.result.retMsg.thumbnailPic;i(l,o,$(this).parent())}else 410==a.result.retCode?r("上传失败","图片格式错误或非图片！","warning"):420==a.result.retCode?r("上传失败","图片大小不能超过6M！","warning"):r("上传失败","系统繁忙，请稍后重试！","warning");n(s),e=!0},fail:function(t,i){var a=$(this).parent();i.total>6e6?r("上传失败","图片大小不能超过6M！","warning"):r("上传失败","系统繁忙，请稍后重试！","warning"),n(a),e=!0}}).bind("fileuploadadd",function(){var t=$(this).parent();t.find("span").text("正在上传"),e=!1})};$("body").on("click",".image-item.image.upload-image",function(){var t=$(this).siblings(".image-item.fileinput-button");$(this).remove(),n(t)});var r=function(t,e,i,n,a){new Dialog({title:t,content:e,icon:i,confirmBtn:!0,cancelBtn:n,confirmCallback:a})},s=function(t,e,i){$.get("remarkInfo?t="+(new Date).getTime(),{remarkId:e},function(e){$(t).empty(),$(t).append(e),l(i),a(t),$(".evaluate-text-content").placeholder({customClass:"my-placeholder"})})},l=function(t){$(t).parent().parent(".prod-line").next().find("li.reply-content[style!='none']").size()>0?($(t).empty(),$(t).append("追加评论<i></i>")):($(t).empty(),$(t).append("查看评价<i></i>"))};$("body").on("click",".unfold, .fold",function(){var t=$(this).parent().parent(".prod-line").next(),e=$(this).closest("tr").find(".remarkId").val();$(this).is(".unfold")?($(this).removeClass("unfold").addClass("fold"),0==t.find("td").size()?(t.empty(),s(t,e,this)):l(this)):(d(t),$(this).removeClass("fold").addClass("unfold"),l(this)),t.toggle()});var o=function(){$(this).is(":disabled")?$(this).removeClass("btn-cancel").addClass("btn-blue").removeAttr("disabled"):$(this).removeClass("btn-blue").addClass("btn-cancel").attr("disabled","disabled")},d=function(t){var e=$(t).find("span.error-style");e.size()>0&&e.each(function(){$(this).remove()})};$("body").on("click",".submit-evaluate",function(){if(!e)return void r("","图片正在上传中！","warning");var t=$(this).parents("tr.evaluated-info");d(t);var i=$(this),n=i.parent().siblings(".reply-content"),a=n.find(".evaluate-text-content");o.call(this);var l={};if(l.spuId=i.attr("spuId"),l.skuId=i.attr("skuId"),l.replyContent=$.trim(a.val()),l.replyContent.length<2||l.replyContent.length>200)return a.after("<span class='error-style red'>麻烦填写2-200字哦！</span>"),a.val(l.replyContent),a.trigger("propertychange"),void o.call(this);n.find(".image").each(function(){l["picture"+($(this).index()+1)]=$(this).find("img").attr("absOriUrl"),l["picture"+($(this).index()+1)+"Thumbnail"]=$(this).find("img").attr("absThumbUrl")}),l.hasPicture=n.find(".image").size()>0?1:0,l.remarkId=i.attr("remarkId");var c=$(this).parents(".prod-item").find(".unfold, .fold");$.ajax({url:webCtx+"/my/remark/reply-add",type:"POST",data:l,dataType:"JSON",success:function(e){200==e.retCode?(r("","感谢您的分享！","success"),s(t,i.attr("remarkId"),c)):222==e.retCode?(r("","感谢您的分享！全款预定商品评价将会在全面开售后显示！","success"),s(t,i.attr("remarkId"),c)):(r("评论失败","系统错误，请稍后重试！","warning"),o.call(i.get(0)))},error:function(t){0==t.status?window.location.href=window.location:(o.call(i.get(0)),window.location.href=webCtx+"/error/forbidden")}})});var c,u="8.0",p=navigator.userAgent.toLowerCase(),f=p.indexOf("msie")>-1;f?(c=p.match(/msie ([\d.]+)/)[1],u>=c&&$("body").on("keyup",".evaluate-text-content",function(){var t=$(this).val().length;if(t>=2){var e=$(this).next("span.error-style");e.size()>0&&e.remove()}t>=200&&$(this).val($(this).val().substr(0,200)),$(this).parent().find(".text-size").text($(this).val().length)})):$("body").on("input propertychange",".evaluate-text-content",function(){var t=$(this).val().length;if(t>=2){var e=$(this).next("span.error-style");e.size()>0&&e.remove()}t>=200&&$(this).val($(this).val().substr(0,200)),$(this).parent().find(".text-size").text($(this).val().length)})});