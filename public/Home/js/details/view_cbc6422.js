var fetchRemarkHtml;$(function(){function t(){if(1==spuInstallment){var t=$("#add-num").val(),a=parseFloat($("#salePrice").val())*t;$(".service-tags>li.on").each(function(){var e=parseFloat($(this).attr("svc-price"))*t;a+=e}),e(k,parseFloat(a)),$("#installment_dt,#j_installment").show()}}function e(t,e){return $.get(webCtx+"/product/getInstallmentDataDetail",{spuId:t,money:e},function(t){if(200==t.retCode){var e=t.installmentInfoData;a(e)}}),null}function a(t){$("#min-perpay").empty().html("<dfn>&yen;</dfn>"+t.minPerPayInfo+"期");var e=$("#installment-tbd");e.empty();var a=t.perInstallmentInfoList;$.each(a,function(t,a){var n=$('<tr><td class="red"><dfn>&yen;</dfn>'+a.perPay+"</td> <td>"+a.num+"期</td> <td>共计约<dfn>&yen;</dfn>"+a.totalPay+" 含"+100*a.userRate+"%手续费</td></tr>");e.append(n)})}function n(){var t=!0,e=isSecondBuy?"/product/second-buy/isAllowedSell":"/product/isAllowedSell",a=s();return $.ajax({async:!1,type:"GET",url:webCtx+e,data:$.param({skuId:a.skuId,num:a.num,bSkuIds:a.bundleSkuIds,suiteCode:a.suiteCode,sSkuIds:a.serviceSkuIds},!0),success:function(e){return isSecondBuy&&-1==e.data?(window.productStore=0,i(),void(t=!1)):void(1!=e.data?(C.html(e.msg).show(),t=!1):C.hide())},error:function(){C.html("系统繁忙，请稍后重试！").show(),t=!1}}),t}function s(){var t={},e=$("li.sub-sku.on").attr("sku-id"),a=parseInt($("#add-num").val());a>maxNumberPerUser&&(a=maxNumberPerUser,$("#add-num").val(a));var n=[];$(".service-tags>li.on").each(function(){n.push(parseInt($(this).attr("sku-id")))});var s=$(".J_package_tags > li.on").attr("suiteCode");("undefined"==typeof s||null==s)&&(s="");var i=[];return""!=s&&void 0!=s&&$(".J_package_container").find("table[suiteCode='"+s+"'] .J_bundle_sku_box").each(function(){i.push(parseInt($(this).find(".J_bundle_sku_color span.selected").attr("bundleSkuId")))}),t.skuId=e,t.num=a,t.serviceSkuIds=n,t.suiteCode=s,t.bundleSkuIds=i,t}function i(){var t,e,a=o(timeLong,uptimeLong,downtimeLong),n=!0;uptimeLong>timeLong?(t="btn-disabled",e="立即秒杀"):timeLong>=downtimeLong?(t="btn-disabled",e="商品已下架",a="",clearInterval(P)):window.productStore?(t="btn-confirm second-buy",e="立即秒杀",n=!L.hasClass("second-buy")):(t="btn-disabled",e="已秒完",a=""),n&&L.removeClass().addClass("btn-next "+t).attr("title",e).text(e),J.html(a)}function o(t,e,a){var n,s,i,o,r,l;if(e>t)n=e-t,l="开始";else{if(!(a>t))return"已结束";n=a-t,l="结束"}return s=parseInt(n/864e5)>9?parseInt(n/864e5):"0"+parseInt(n/864e5),i=parseInt(n/36e5)%24>9?parseInt(n/36e5)%24:"0"+parseInt(n/36e5)%24,o=parseInt(n/6e4)%60>9?parseInt(n/6e4)%60:"0"+parseInt(n/6e4)%60,r=parseInt(n%6e4/1e3)>9?parseInt(n%6e4/1e3):"0"+parseInt(n%6e4/1e3),"<span>"+s+"</span>天<span>"+i+"</span>时<span>"+o+"</span>分<span>"+r+"</span>秒后"+l}var r,l=!1,d=$(".prod-container"),c=(d.find("#j_SpecImgs ul li"),d.find("#j_SpecItems ul li"),$(".prod-main-info")),u=c.find(".prod-tab-box ul li"),p=c.find(".prod-main-box"),m=0,f=c.offset().top,v=c.find(".prod-main-tab"),g=v.find(".thumb-goods"),b=v.find("button"),C=($("#j_PackageContainer"),$("#j_PkgBox"),$("#error-msg")),k=$("#spuId").val();!function(){$(".color-box>li.on").size()<1&&$(".color-box>li:first").addClass("on"),window.productStore=parseInt($(".color-box>li.on").attr("sku-store")),t(),$.get(webCtx+"/product/getCommodityEvaluation",{spuId:k,preview:$("#preview").val()},function(t){if(200==t.retCode){var e=t.commodityEvaluation;1==e.display&&e.pcEval.length>0&&($(".tab-evaluation").show(),r=e)}}),$(".tab-evaluation").on("click",function(){var t=$(".prod-main-evaluation>div.section");1==r.display&&r.pcEval.length>0&&""==$.trim(t.html())&&t.html(r.pcEval)}),$.ajax({type:"GET",dataType:"json",url:webCtx+"/favorite/count",data:{spuId:$("#spuId").val(),goodsType:0},success:function(t){200==t.retCode&&$("#favCount").text(t.retMsg)}}),$.ajax({type:"POST",dataType:"json",url:webCtx+"/product/countRemark",data:{spuId:$("#spuId").val(),fullpaySkuIdSet:fullpaySkuIdSet},success:function(t){$("#remarkCountSpan").text(" ( "+t.remarkCount+" ) ")}});var e=$("#j_CollectTrigger").parent();$.ajax({type:"GET",dataType:"json",url:webCtx+"/favorite/isMemberFavorite",data:{goodsId:$(".color-box>li.on:first").attr("sku-id"),goodsType:0},success:function(t){200==t.retCode?e.hasClass("collect")&&e.removeClass("collect").addClass("collected"):e.hasClass("collected")&&e.removeClass("collected").addClass("collect")},error:function(){e.hasClass("collected")&&e.removeClass("collected").addClass("collect")}}),$("#j_CollectTrigger").parent().on("click",function(){if(!LoginConfirm.isLogin())return void LoginConfirm.redirect();var t=$(this);return t.hasClass("collected")?($.ajax({data:{goodsId:$(".color-box>li.on:first").attr("sku-id"),goodsType:0},type:"POST",dataType:"json",url:webCtx+"/my/favorite/remove",success:function(e){200==e.retCode?($("#favCount").text(parseInt($("#favCount").text())-1),t.addClass("collect").removeClass("collected")):500==e.retCode&&y("失败","您已经取消收藏过此商品，请刷新重试！","warning")}}),!1):void $.ajax({data:{goodsId:$(".color-box>li.on:first").attr("sku-id"),goodsType:0},type:"POST",dataType:"json",url:webCtx+"/my/favorite/add",success:function(e){200==e.retCode?(t.removeClass("collect").addClass("collected"),$("#favCount").text(parseInt($("#favCount").text())+1)):y("失败","您已经收藏过此商品，请刷新重试！","warning")},error:function(){LoginConfirm.redirect()}})})}(),function(){function t(){$("#j_SpecItems").on("mouseenter","li",function(){return $(this).hasClass("current")?!1:($(this).addClass("current").siblings().removeClass("current"),$("#j_smallPic").length&&($("#j_smallPic")[0].src=$(this).children("a").children("img")[0].src),$("#j_SpecImgs li").eq($(this).index()).css({display:"block",opacity:0,zIndex:9}).stop().animate({opacity:1},800).siblings().css({zIndex:1}).stop().animate({opacity:0},500,function(){$(this).css({display:"none"})}),!1)}),$("#j_SpecItems li").first().trigger("mouseenter")}t(),$("li.sub-sku").on("click",function(){var e=$(this).attr("sku-id"),a=$("#bigImgUl"),n=$("#smallImgUl");a.empty(),n.empty(),C.empty(),$.each(skuImageJson,function(t,s){if(e==s.skuId){var i=$('<li><img src="'+imgHost+s.bigPic+'" alt="商品图片" /></li>');a.append(i);var o=$('<li><a href="#" ><img src="'+imgHost+s.smallPic+'" /></a></li>');n.append(o)}}),t(),function(){var t=n.find("li").size()>1?1:0,e=n.find("li").eq(t).find("img").attr("src");$(".main-prod").find("img").attr("src",e)}();var s=$("#j_colors").attr("marketable"),o=$(this).attr("sku-fullpay"),r=$(this).parent().attr("spuInstallment");window.productStore=parseInt($(this).attr("sku-store"));var l="btn-confirm add-cart",d="加入购物车";isSecondBuy?i():("0"==s?(l="btn-disabled",d="商品已下架"):0==window.productStore?(l="btn-disabled",d="商品暂时缺货"):"1"==o?(l="btn-appointment payall-order",d="全款预定"):"1"==r&&(l="btn-confirm now-buy",d="立即购买"),$(".btn-next").removeClass().addClass("btn-next "+l).attr("title",d).text(d));var c=$("#j_CollectTrigger").parent();$.ajax({type:"GET",dataType:"json",url:webCtx+"/favorite/isMemberFavorite",data:{goodsId:e,goodsType:0},success:function(t){200==t.retCode?c.hasClass("collect")&&c.removeClass("collect").addClass("collected"):c.hasClass("collected")&&c.removeClass("collected").addClass("collect")},error:function(){c.hasClass("collected")&&c.removeClass("collected").addClass("collect")}})})}(),$("#J_Share").hover(function(){$(this).find(".share-box").fadeIn()},function(){$(this).find(".share-box").fadeOut()}),u.on({click:function(){return $(this).hasClass("current")?!1:($(this).addClass("current").siblings().removeClass("current"),m>=f&&$("body,html").animate({scrollTop:c.offset().top},1),p.find(".prod-main-"+$(this).attr("v")).css({display:"block"}).siblings().css({display:"none"}),!1)}}).first().click(),$(window).on({scroll:function(){c[0].getBoundingClientRect().top<=0?(c.css({paddingTop:61}),v.addClass("fixed"),g.show(),b.show()):(c.css({paddingTop:0}),v.removeClass("fixed"),b.hide(),g.hide())}}).scroll(),$(".nettype-tags > li,.storage-tags > li,.color-box > li").on("click",function(){$(this).addClass("on").siblings().removeClass("on")}),$(".service-tags > li[name=broken-svc]").on("click",function(){var e=$(this).attr("class");$(".service-tags > li[name=broken-svc]").removeClass("on"),$(this).attr("class",e),$(this).toggleClass("on"),t()}),$(".service-tags > li[name=delay-svc]").on("click",function(){var e=$(this).attr("class");$(".service-tags > li[name=delay-svc]").removeClass("on"),$(this).attr("class",e),$(this).toggleClass("on"),t()}),fetchRemarkHtml=function(t,e){var a=$("#remarkHandler").attr("prodId"),n=$("#onlyPicChecked").size()>0?$("#onlyPicChecked").hasClass("current"):!1,s=$(".prod-main-evaluate").empty();window.scrollTo(0,$(".prod-main-info:first").position().top),$.get(webCtx+"/product/remark",{prodId:a,onlyHasPicture:n,fullpaySkuIdSet:fullpaySkuIdSet,pageNum:t,pageSize:e},function(t){s.empty(),s.append(t),x()})},$("#remarkHandler").click(function(){l||fetchRemarkHtml(),l=!0});var y=function(t,e,a,n,s){new Dialog({title:t,content:e,icon:a,confirmBtn:!0,cancelBtn:n,confirmCallback:s})};$("body").on("click",".btn-evaluator",function(){!LoginConfirm.isLogin()&&LoginConfirm.redirect();var t=$("#spuId").val();$.ajax({type:"POST",dataType:"json",url:webCtx+"/my/remark/addRemarkVerify",data:{prodId:t},success:function(t){200==t.retCode?window.location.href=webCtx+"/my/remark/unRemark-prod":700==t.retCode?y("失败",t.retMsg,"warning"):710==t.retCode?y("失败",t.retMsg,"warning"):600==t.retCode?LoginConfirm.redirect():y("失败","系统错误！","warning")}})}),$("body").on("click",".evaluate-toolbar a",function(){$(this).hasClass("current")||($(this).addClass("current").parent().siblings().find("a").removeClass("current"),fetchRemarkHtml())}),function(){$(".J_bundle_sku_box").each(function(){if(0==$(this).find("span.J_enable").size()){var t=$(this).parents(".J_suite_table").attr("suiteCode");$(".J_package_tags").find("li[suiteCode='"+t+"']").addClass("disabled")}else $(this).find("span.J_enable:first").addClass("selected")})}(),$("body").on("click",".package-tags li",function(){if($(this).hasClass("disabled"))return!1;$(this).addClass("on").siblings().removeClass("on"),$("#salePrice").val(parseFloat($(this).attr("salePrice"))),t();var e=$(this).attr("suiteCode"),a=$(".package-container");if(void 0==e)return void a.hide();a.show();var n=a.find("table[suiteCode='"+e+"']");n.show(),n.siblings().hide(),n.find(".ancillary-prod").each(function(){var t=$(this).find(".color-box");I(t)})}),$("body").on("click",".color-box span",function(){$(this).hasClass("selected")||($(this).addClass("selected").siblings().removeClass("selected"),I($(this).parent()))});var I=function(t){var e=imgHost+t.find("span.selected").attr("imgsrc");t.parents(".J_bundle_sku_box").find(".ap-img").attr("src",e)},x=function(){var t=$(".prod-main-info"),e=(t.find(".prod-main-box"),400);$(".evaluate-pic a").unbind().removeClass("current"),$(".evaluate-pic dd").unbind().css({display:"none",width:0,height:0}),$(".evaluate-pic").each(function(t,a){var n=$(a).find("dt a"),s=$(a).find("dd");n.on("click",function(){var t=$(this);if($(this).hasClass("current"))return s.stop().animate({width:0,height:0},300,function(){$(this).css({display:"none"})}),$(this).removeClass("current"),!1;$(this).addClass("current").siblings().removeClass("current");var a=new Image,n=w=h=0;$(a).load(function(){s.find("img").size()<=0&&s.html("<img>"),a.width&&(a.width>a.height?(w=a.width>e?e:a.width,h=w*a.height/a.width):(h=a.height>e?e:a.height,w=h*a.width/a.height),s.css({display:"block"}).stop().animate({width:w,height:h},300).children("img").attr({src:t.attr("data-img")}).animate({width:w-2,height:h-2},300))}).error(function(){n++,$(a).load(),n>3}),a.src=t.attr("data-img");var i=setInterval(function(){a.width?clearInterval(i):$(a).load()},1);return!1}),s.click(function(){return $(this).stop().animate({width:0,height:0},300,function(){$(this).css({display:"none"})}),n.removeClass("current"),!1})})},S=function(){return!0};$("body").on("click",".payall-order",function(){if(n()){var t=s();window.location=webCtx+"/order/quick/confirm?skuId="+t.skuId+"&num="+t.num+"&sSkuIds="+t.serviceSkuIds+"&suiteCode="+t.suiteCode+"&bSkuIds="+t.bundleSkuIds}}),$("body").on("click",".add-cart",function(){if($(this).hasClass("btn-disabled"))return!1;if(S()){var t=s(),e=t.num;isNaN(e)&&(e=1),e=e>3?3:e,e=1>e?1:e,$.ajax({type:"POST",url:webCtx+"/shoppingcart/cartAdd",data:$.param({skuId:t.skuId,num:e,sSkuIds:t.serviceSkuIds,bSkuIds:t.bundleSkuIds,suiteCode:t.suiteCode},!0),success:function(t){if(200==t.retCode&&(C.hide(),window.location=webCtx+"/shoppingcart"),200!=t.retCode)if(t.retMsg.match("^{(.+:.+,*){1,}}$")){var e=$.parseJSON(t.retMsg);C.html(e.tip).show()}else C.html(t.retMsg).show()},error:function(){C.show().html("网络异常，请刷新页面后重试")}})}}),$("body").on("click",".now-buy, .second-buy",function(){if(n()){var t=s(),e=isSecondBuy?"/second-buy/confirm":"/order/quick/confirm";window.location=webCtx+e+"?skuId="+t.skuId+"&num="+t.num+"&sSkuIds="+t.serviceSkuIds+"&suiteCode="+t.suiteCode+"&bSkuIds="+t.bundleSkuIds}}),$("li[name=netTypeLi]").unbind().bind("click",function(){var t=$(this),e=$("#netType").val(),a=($("#storage").val(),t.attr("netType"));e!=a&&($("#netType").val(a),$("#queryFlag").val(1),$("#prod-detail-form").attr("action",webCtx+"/product/querySpuIdByParams"),$("#prod-detail-form").submit())}),$("li[name=storageLi]").unbind().bind("click",function(){var t=$(this),e=($("#netType").val(),$("#storage").val()),a=t.attr("storage");e!=a&&($("#storage").val(a),$("#queryFlag").val(2),$("#prod-detail-form").attr("action",webCtx+"/product/querySpuIdByParams"),$("#prod-detail-form").submit())});var _=function(t){t.hasClass("disabled")||t.addClass("disabled")},j=function(t){t.hasClass("disabled")&&t.removeClass("disabled")};$("#inc").click(function(){var e=parseInt($("#add-num").val());return e>=maxNumberPerUser?void T.flash():($("#add-num").val(e+1),e+1>1&&j($("#dec")),void t())}),$("#dec").click(function(){if($(this).hasClass("disabled"))return!1;var e=parseInt($("#add-num").val());1>=e||(j($(this)),$("#add-num").val(e-1),1>=e-1&&_($(this)),t())}),$("#add-num").on({click:function(){this.select()},blur:function(){var t=$(this).val();isNaN(parseInt(t))||parseInt(t)>3||parseInt(t)<=1||isSecondBuy?($(this).val("1"),_($("#dec")),isNaN(parseInt(t)&&parseInt(t)>3)||T.flash()):($(this).val(parseInt(t)),t>=1&&j($("#dec")))},keyup:function(t){var e=t.keyCode?t.keyCode:t.which;if(13==e){var a=$(this).val();parseInt(a)>0?$(".J_buy-button").trigger("click"):($(this).val("1"),_($("#dec")))}},keypress:function(t){var e=t.keyCode?t.keyCode:t.which;return 13==e?!1:void 0}});var T={flash:function(){var t=0,e=setInterval(function(){return 5==t?(clearInterval(e),void($("#order-num-msg").hasClass("red")&&$("#order-num-msg").toggleClass("red"))):($("#order-num-msg").toggleClass("red"),void t++)},300)}};$("#J_Share a").each(function(){var t=$(this).attr("href");$(this).attr("href",encodeURI(t))}),$("#j_installment .btn-show-more").on("mouseenter",function(){$("#j_installment").find(".installment-popup").fadeIn()}),$("#j_installment .installment-popup").on("mouseleave",function(){$("#j_installment").find(".installment-popup").hide()}),$("#j_installment .installment-popup .icon-close").on("click",function(){$(this).parent().fadeOut()}),$("body").on("click",".pagination .j_go_ajax",function(){var t=($(this).attr("data-url"),$(this).attr("data-total")),e=$(this).attr("pageSize"),a=$(this).parent().find("input").val();a&&/^\d+$/.test(a)&&parseInt(a)<=t&&fetchRemarkHtml(a,e)});var P,L=$(".btn-next"),J=$(".count-down-text");isSecondBuy&&(i(),P=setInterval(function(){timeLong+=1e3,i()},1e3))});